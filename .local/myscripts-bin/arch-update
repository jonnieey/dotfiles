#!/usr/bin/env bash
set -euo pipefail

echo "=== Arch Linux Safe Update (yay) ==="

# ─────────────────────────────────────────────
# 1. Prevent running as root
# ─────────────────────────────────────────────
if [[ $EUID -eq 0 ]]; then
  echo "Do NOT run this script as root."
  exit 1
fi

# ─────────────────────────────────────────────
# 2. Ask for the administrator password upfront
# ─────────────────────────────────────────────
# The script will prompt for the sudo password at the beginning and then
# run all privileged commands without asking for the password again.
sudo -v

# Keep-alive: update existing sudo time stamp until the script has finished.
while true; do
  sudo -n true
  sleep 60
  kill -0 "$$" || exit
done 2>/dev/null &

# ─────────────────────────────────────────────
# 3. Update mirrorlist for faster downloads
# ─────────────────────────────────────────────
# if command -v reflector &>/dev/null; then
#   echo ">> Updating mirrorlist with reflector"
#   sudo reflector --latest 10 --protocol https --sort rate --save /etc/pacman.d/mirrorlist
# else
#   echo ">> reflector is not installed, skipping mirrorlist update."
#   echo "   Install it with 'sudo pacman -S reflector' to enable this feature."
# fi

# ─────────────────────────────────────────────
# 4. Refresh pacman keyring safely and quickly
# ─────────────────────────────────────────────
# echo ">> Updating archlinux-keyring package"
# sudo pacman -Sy --needed --noconfirm archlinux-keyring
#
# echo ">> Refreshing pacman keys using WKD"
# # This is much faster than 'pacman-key --refresh-keys'
# sudo archlinux-keyring-wkd-sync

# ─────────────────────────────────────────────
# 5. Full system update (repo + AUR)
# ─────────────────────────────────────────────
echo ">> Updating system with yay"
yay -Syu --needed --noconfirm

# ─────────────────────────────────────────────
# 6. Remove orphaned packages
# ─────────────────────────────────────────────
echo ">> Removing orphaned packages"
orphans=$(pacman -Qtdq || true)
if [[ -n "$orphans" ]]; then
  sudo pacman -Rns --noconfirm $orphans
else
  echo "No orphaned packages found"
fi

# ─────────────────────────────────────────────
# 7. Clean package cache (safe)
# ─────────────────────────────────────────────
echo ">> Cleaning package cache"
sudo paccache -r    # keep last 3 versions
sudo paccache -ruk0 # remove uninstalled package cache

# ─────────────────────────────────────────────
# 8. Yay cache cleanup
# ─────────────────────────────────────────────
echo ">> Cleaning yay cache"
yay -Sc --noconfirm

# ─────────────────────────────────────────────
# 9. Optional systemd cleanup
# ─────────────────────────────────────────────
echo ">> Cleaning journal logs (keep 2 weeks)"
sudo journalctl --vacuum-time=2weeks

# ─────────────────────────────────────────────
echo "=== Update Complete ==="
echo "Reboot recommended if kernel, systemd, or glibc were updated."
